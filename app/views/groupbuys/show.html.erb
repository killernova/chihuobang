<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js" type="text/javascript"></script>

<% provide :title, t(:groupbuy_detail) %>
<div class="row">
  <div class="large-2 columns">
    <%= image_tag @title_pic, class: 'profile-image' if @groupbuy %>
  </div>

  <div class="large-10 columns">
    <h2><%= @groupbuy.title %></h2>      
    <h3><%= "[No. #{@groupbuy.id.to_s.rjust(10,'0')}]" %></h3> 
    <%= groupbuy_info(@groupbuy) %>     
  </div>
</div>
<div class="row">
  <div class="small-12 columns">
    <table style="width:100%">
      <tr>
        <th><%=t(:start_time)%></th>
        <td><%= @groupbuy.start_time.strftime("%Y-%m-%d %H:%M") %></td>
      </tr>
      <tr>
        <th><%=t(:end_time)%></th>
        <td><%=@groupbuy.end_time.strftime("%Y-%m-%d %H:%M")%></td>
      </tr>
      <tr>
        <th><%=t(:inventory)%></th>
        <td><%=@groupbuy.goods_maximal%><%=@groupbuy.goods_unit%></td>
      </tr>
      <tr>
        <th><%=t(:goods_minimal)%></th>
        <td><%=@groupbuy.goods_minimal%><%=@groupbuy.goods_unit%></td>
      </tr>
      <tr>
        <th><%=t(:price)%></th>
        <td>￥<%=@groupbuy.price%>/<%=@groupbuy.goods_unit%></td>
      </tr>
      <tr>
        <td colspan='2'>
          <% @content_pic.each do |pic| %>
          <div class="content-pictures columns small-12 medium-8 medium-center large-6 large-center">
            <%= image_tag pic.try(:image).present? ? pic.image : pic %>
          </div>
          <% end %>
          <%= @groupbuy.body.html_safe  %>
        </td>
      </tr>
    </table>

  </div>
</div>
<% if current_user == @groupbuy.user || current_user.try(:role) == '1' %>  
<div class="row">
  <div class="small-12 columns">
    <%= link_to '<i class="fa fa-pencil"></i>'.html_safe + ' ' + t(:edit), edit_groupbuy_path(@groupbuy), class:"tiny button radius" %>
    <%= link_to '<i class="fa fa-times"></i>'.html_safe + ' ' + t(:delete), @groupbuy,method: :delete,
    class:"tiny button alert radius",
      data: {confirm: '?'} %>      
    </div>
  </div>
  <% end %>
  <div class="row">
    <div class="small-12 columns">
      <ul class="tabs" data-tab role="tablist">
        <li class="tab-title active">
          <a href="#participants"><i class="fa fa-cart-plus"></i><%=t(:buys)%> (<%=@groupbuy.participants_count.to_i%>)</a>
        </li>
        <li class="tab-title">
          <a href="#comments"><i class="fa fa-comments"></i><%=t(:comments)%> (<%=@groupbuy.comments_count.to_i%>)</a>
        </li>
      </ul>
      <div class="tabs-content panel">
        <div class="content active" id="participants" data-url='<%=groupbuy_participants_path(@groupbuy)%>'>
          <%=render 'participants/form' ,:locals=>{@parent=>@parent,@participant=>@participant} if current_user && @groupbuy.end_time.to_i > Time.zone.now.to_i %>
          <%= render @participants %>
        </div>
        <div class="content" id="comments"  data-url='<%=groupbuy_comments_path(@groupbuy)%>'>
          <%=render 'comments/form' ,:locals=>{@parent=>@parent,@comment=>@comment} if current_user%>
          <div class="comments-list">
            <%= render @comments %>
          </div>
          <% if @active %>
          <a style="width:100%" href="#" class="more-comments tiny expanded button" data-parent="<%= params[:controller].gsub(/\w$/, '') %>" data-count="<%= @groupbuy.comments.count %>" data-id="<%= @groupbuy.id %>" data-url="<%= groupbuys_more_comments_path %>"><%= t(:more) %></a>
          <% end %>
        </div>
      </div>
    </div>
  </div>


  <script>
  alert('4');
    wx.config({
    debug: false,  //开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
    appId: "<%= @appId %>", // 必填，公众号的唯一标识
    timestamp: "<%= @timestamp %>", // 必填，生成签名的时间戳
    nonceStr: "<%= @noncestr %>", // 必填，生成签名的随机串
    signature: "<%= @sign %>",// 必填，签名，见附录1
    jsApiList: ['onMenuShareTimeline', 'onMenuShareAppMessage'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
  });
alert('5');

    wx.ready(function(){
      alert('1');
      var url = location.href;
      wx.onMenuShareTimeline({
    title: "<%= @title %>", // 分享标题
    link: url, // 分享链接
    imgUrl: "<%= @img_url %>", // 分享图标
    success: function () {
        // 用户确认分享后执行的回调函数
        
      },
      cancel: function () {
        // 用户取消分享后执行的回调函数
      }
    });

      wx.onMenuShareAppMessage({

      title: "<%= @title %>", // 分享标题
      desc: "<%= @desc %>", // 分享描述
      link: url, // 分享链接
      imgUrl: "<%= @img_url %>", // 分享图标
      type: 'link', // 分享类型,music、video或link，不填默认为link
      dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
      success: function () {
          // 用户确认分享后执行的回调函数
          alert('2');
        },
        cancel: function () {
          // 用户取消分享后执行的回调函数
          alert('3');
        }

      });

    });

  </script>

