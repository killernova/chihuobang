
<% provide :title, t(:event_detail) %>

<div class="row">
  <div class="large-2 columns">
    <%= image_tag @event.pic_url, class: 'profile-image round' if @event %>
  </div>
  <div class="large-10 columns">
    <h2><%= @event.title %></h2>
  </div>
</div>
<div class="row">
  <div class="small-12 columns">
    <%= event_info(@event) %><br>
  </div>
</div>
<div class="row">
  <div class="small-12 columns">
    <table style="width:100%">
      <tr>
        <th><%=t(:event)%> No.</th>
        <td>#<%= @event.id.to_s.rjust(10,'0') %></td>
      </tr>
      <tr>
        <th><%=t(:start_time)%></th>
        <td><%= @event.start_time.strftime("%Y-%m-%d %H:%M") %></td>
      </tr>
      <tr>
        <th><%=t(:duration)%></th>
        <td><%=@event.event_duration[0] + t(:day) + @event.event_duration[1] + t(:hour) + @event.event_duration[2] + t(:minute)  %></td>
      </tr>
      <tr>
        <th><%=t(:address)%></th>
        <td class="event-address"><%=@event.address%></td>
      </tr>
      <tr>
        <th><%=t(:contact)%></th>
        <td>
          <span class="contact-name"><%= @event.name.present? ? @event.name : @event.user.nickname %></span>
          <span class="contact-mobile"><%= @event.user.mobile %></span>
        </td>
      </tr>
      <tr>
        <th><%=t(:limited_people)%></th>
        <td><%=@event.limited_people%></td>
      </tr>
      <tr>
        <th><%=t(:participants)%></th>
        <td><%=@participants.count%></td>
      </tr>
      <tr>
        <th><%=t(:price)%></th>
        <td><%= @event.price.to_i > 0 ? '￥' + @event.price : t(:free) %></td>
      </tr>
      <tr>
        <td colspan='2'><%= @event.body.html_safe  %></td>
      </tr>
    </table>
  </div>
</div>
<% if current_user == @event.user %>
<div class="row">
  <div class="small-12 columns">
    <%= link_to '<i class="fa fa-pencil"></i>'.html_safe + ' ' + t(:edit), edit_event_path(@event), class:"tiny button radius" %>
    <%= link_to '<i class="fa fa-times"></i>'.html_safe + ' ' + t(:delete), @event, method: :delete,
    class:"tiny button alert radius",
      data: {confirm: '?'} %>
    </div>
  </div>
  <% end %>
  <div class="row">
    <div class="small-12 columns">
      <ul class="tabs" data-tab role="tablist">
        <li class="tab-title active">
          <a href="#participants"><i class="fa fa-user-plus"></i><%=t(:goings)%> (<%=@event.participants_count%>)</a>
        </li>
        <li class="tab-title">
          <a href="#comments"><i class="fa fa-comments"></i><%=t(:comments)%> (<%=@event.comments_count%>)</a>
        </li>
      </ul>
      <div class="tabs-content panel">
        <div class="content active" id="participants">
          <%=render 'participants/form' ,:locals=>{@parent=>@parent,@participant=>@participant} if current_user%>
          <%= render @participants %>
        </div>
        <div class="content" id="comments">
          <%=render 'comments/form' ,:locals=>{@parent=>@parent,@comment=>@comment} if current_user%>
          <div class="comments-list">
            <%= render @comments %>
          </div>
          <% if @active %>
          <a style="width:100%" href="#" class="more-comments tiny expanded button" data-parent="<%= params[:controller].gsub(/\w$/, '') %>" data-count="<%= @events.comments.count %>" data-id="<%= @event.id %>" data-url="<%= events_more_comments_path %>"><%= t(:more) %></a>
          <% end %>
        </div>
      </div>
    </div>
    <div id="container" class="gaodemap"></div>
    <div id="tip">
      <span id="result"></span>
    </div>
  </div>


  <style type="text/css">
    html{height:100%}
    body{height:100%;margin:0px;padding:0px}
    #container {width:80%; height: 300px; position: relative; left: 10%; }
  </style>


  <script type="text/javascript">
  
    var address = $('.event-address').text();

    var map = new AMap.Map("container", {
      resizeEnable: false
    });
    function geocoder() {
      AMap.service('AMap.Geocoder',function(){//回调函数
        //实例化Geocoder
        var geocoder = new AMap.Geocoder({
        });

        //地理编码,返回地理编码结果
        geocoder.getLocation(address, function(status, result) {
          if (status === 'complete' && result.info === 'OK') {
            geocoder_CallBack(result);

          }
        });
      });
    }

    function addMarker(i, d) {
      var marker = new AMap.Marker({
        map: map,
        position: [ d.location.getLng(),  d.location.getLat()]
      });
      var infoWindow = new AMap.InfoWindow({
        content: d.formattedAddress,
        offset: {x: 0, y: -30}
      });
      marker.on("mouseover", function(e) {
        infoWindow.open(map, marker.getPosition());
      });
    }
    //地理编码返回结果展示
    function geocoder_CallBack(data) {
      var resultStr = "";
        //地理编码结果数组
        var geocode = data.geocodes;
        for (var i = 0; i < geocode.length; i++) {
            //拼接输出html
            resultStr += "<span style=\"font-size: 12px;padding:0px 0 4px 2px; border-bottom:1px solid #C1FFC1;\">" + "<b>地址</b>：" + geocode[i].formattedAddress + "" + "&nbsp;&nbsp;<b>的地理编码结果是:</b><b>&nbsp;&nbsp;&nbsp;&nbsp;坐标</b>：" + geocode[i].location.getLng() + ", " + geocode[i].location.getLat() + "" + "<b>&nbsp;&nbsp;&nbsp;&nbsp;匹配级别</b>：" + geocode[i].level + "</span>";
            addMarker(i, geocode[i]);
          }
          map.setFitView();
          document.getElementById("result").innerHTML = resultStr;
        }

      </script>


