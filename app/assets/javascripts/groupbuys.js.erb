//var _cities = <%#=Ecstore::Region.hash_cities.to_json%>;
//var _districts = <%#=Ecstore::Region.hash_districts.to_json%>;

//= require ckeditor/init
//= require foundation-datepicker.min
// if session[:locale] == 'zh'
//= require foundation-datepicker.zh-CN
//= require photos


function checkPositiveInteger(obj){
  var num = obj.val();
  if(isNaN(num) || num < 1 || num % 1 != 0) {
    obj.val('');
    var errmsg = '只能为正整数！';
    alert(errmsg);
  }
}

function checkPositiveNumber(obj){
  var num = obj.val();
  if(isNaN(num) || num < 0 ) {
    obj.val('');
    var errmsg = '只能为正数！';
    alert(errmsg);
  }
}


$(document).ready(function(){
  $('.new-groupbuy').find('input').each(function(){
    if(($(this).val()=='0' || $(this).val()=='0.0') && location.pathname.split('/')[2] == 'new'){
      $(this).val('');
    }
  });
});

$('.new_participant').on('change', '.goods-weight', function(){
  var that = $(this);
  var nums = that.val();
  if(nums == '' || nums == undefined || isNaN(nums) == true || parseInt(nums) < 1) {
    $(this).val('');
    alert("只能输入正数");
    return;
  }
});

//倒计时

$('.groupbuy-list').each(function(){
  var endTime = $(this).data('endtime');
  var day = $(this).data('day');
  var that = $(this);
  window.setInterval(function(){
    var EndTime= endTime;
    var NowTime = new Date();
    var t =EndTime * 1000 - NowTime.getTime();
    if(t < 0) {
      //console.log(t);
      var over = $('.groupbuys-index-list').data('over');
      that.find('.countdown').text(over);
      return;
    }

    var d=Math.floor(t/1000/60/60/24);
    var h=Math.floor(t/1000/60/60%24);
    var m=Math.floor(t/1000/60%60);
    var s=Math.floor(t/1000%60);

    that.find('.countdown-day').text(d + day);
    that.find('.countdown-hour').text(h + ':');
    that.find('.countdown-minute').text(m + ':');
    that.find('.countdown-second').text(s);
  }, 1000);



  //setInterval(getRTime,1000);
});

//--------时间选择插件----------//
$('.fdatepicker').fdatepicker({
  language: 'zh',
  format: 'yyyy-mm-dd hh:ii',
  disableDblClickSelection: true,
  pickTime: true
});


//--------------新建团购-----------------//
var unitInput = $('#groupbuy_goods_unit');
var unitText = $('.goods-unit-blank');
if(unitInput.val()){
  if(unitInput.val().replace(/\s/g, '').length > 0) {
    unitText.text(unitInput.val());
  }
  else {
    $('#groupbuy_goods_unit').on('change', function(){
      var val = $(this).val();
      $('.goods-unit-blank').text(val);
    });
  }
}

// 价格不能为负数
$('#groupbuy_price').on('change', function(){
  checkPositiveNumber($(this));
});
$('#groupbuy_market_price').on('change', function(){
  checkPositiveNumber($(this));
});

$('#groupbuy_goods_minimal').on('change', function(){
  checkPositiveNumber($(this));
});

$('#groupbuy_goods_maximal').on('change', function(){
  checkPositiveNumber($(this));
});

//-----------------编辑groupbuy的图片-----------------//
$('.delete-pic').on('click', function(){
  var url = ',/' + $(this).parent().find('img').attr('src').split('/').slice(-2).join('/');
  var id = $(this).parent().data('id');
  var post_url = $(this).parent().data('posturl');
  var that = $(this);
  $.ajax({
    url: post_url,
    type: 'post',
    data: {
      id: id,
      url: url
    },
    success: function(e) {
      if(e != 'failed') {
        that.parent().remove();
        $('.pic_urls').attr('src', e);
      }
    }
  });
});

//-------------------最新版本的编辑图片------------------//

$('.dz-image .trash').on('click', function(){
  var ids = [];
  var deleteIds = $('.delete-ids').val() + ',' + $(this).parent().attr('id');
  $('.delete-ids').val(deleteIds);

  var that = $(this);
  $(this).parent().remove();
  if($('.dz-image').length > 0) {
    $('.dz-image').each(function(){
      ids.push($(this).attr('id'));
    });
  }
  $('.pic-ids').val(ids.join(','));
});
